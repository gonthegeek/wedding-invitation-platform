rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // User documents - users can only access their own data
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Wedding documents
    match /weddings/{weddingId} {
      // Public read access for guest invitations
      allow read: if true;
      
      // Write access for couples (owners) and admins
      allow write: if request.auth != null && 
        (resource.data.coupleId == request.auth.uid || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      
      // Create access for authenticated users
      allow create: if request.auth != null;
    }

    // Guest documents
    match /guests/{guestId} {
      // Guests can read their own data
      allow read: if request.auth != null && 
        (resource.data.email == request.auth.token.email || 
         resource.data.inviteCode == request.auth.token.invite_code);
      
      // Wedding couples and admins can manage guests
      allow write: if request.auth != null && 
        (get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.coupleId == request.auth.uid ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // RSVP documents
    match /rsvps/{rsvpId} {
      // Public read for wedding couples to see responses
      allow read: if request.auth != null;
      
      // Guests can create/update their own RSVPs
      allow write: if request.auth != null;
    }

    // Wedding party documents
    match /weddingParty/{partyId} {
      // Public read for invitation display
      allow read: if true;
      
      // Only wedding couples and admins can manage
      allow write: if request.auth != null && 
        (get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.coupleId == request.auth.uid ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Gift registry documents
    match /giftRegistry/{registryId} {
      // Public read for guests
      allow read: if true;
      
      // Only wedding couples and admins can manage
      allow write: if request.auth != null && 
        (get(/databases/$(database)/documents/weddings/$(resource.data.weddingId)).data.coupleId == request.auth.uid ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }

    // Notification documents
    match /notifications/{notificationId} {
      // Users can only read their own notifications
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // System can create notifications, users can update read status
      allow write: if request.auth != null;
    }
  }
}
